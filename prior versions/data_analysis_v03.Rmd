---
title: "1st Data Analysis"
subtitle: "Use with discretion and QC the results!"
author: "Mario Niepel"
date: "December 2020"
version: "0.3"
output:
     html_document:
          toc: true
          toc_depth: 2
          theme: united 
code_folding: hide
          
---

Sections to implement:
- data import
- auto tidying
- manual cleanup
- examples for simple overview
- place holder for facet plots 
     -> sample from Bin's data (across readouts)
     -> sample from Kaiko
     -> time course
     -> dose response
     -> mouse experiments
     -> Multi-day cell panel screen
     -> Heatmap for arrayed?
- include simple path to Stats
     -> Dunnetts
     -> ANOVA




Todo
- organize code according to sections above
- simple path to basic summary plots

x-axis
y-axis - list with readouts for 'lapply'
legend - in plot with colors
facet-wrap - one (long) variable (e.g CRISPR gRNAs)
facet-grid - two shorter variables (e.g. cell line, time)

- chose box-plot if X is categorical or line-plot if continuous



```{r libraries call, include=FALSE}
require(tidyverse)
require(patchwork)
require(DT)

```

```{r functions, include=FALSE, fig.width=16, fig.height=10}

#// FUNCTION: save ggplots into PDF
     
pdf_plot <- function(plots, name, width, height) {
     
     #// open port to pdf
          pdf(file = paste0(out_dir, name, ".pdf"),   #// The directory you want to save the file in
          width = width, #// The width of the plot in inches
          height = height) #// The height of the plot in inches

     #// display all plots
          for (i in plots) { print(i) }
     
     # close port to pdf
          dev.off()
          invisible(NULL)
}


#// FUNCTION: Custom Box Plots

cust_box_plot <- function(df, x_val, y_val, color, r_fac, c_fac, title, Exp_ID) {

     #// pipe dataframe into plot
          df %>% 

     #// basic plot setup
          ggplot(aes(x = .data[[x_val]], y = .data[[y_val]], fill = .data[[color]])) + 
     #// geoms for box_ and point_
          geom_boxplot(position = position_dodge(width = .9)) +
          geom_point(position = position_jitterdodge(dodge.width = 0.9)) +
     #// custom color scale
          scale_fill_viridis_d(begin = 0.2, end = 1, alpha = 1, direction = 1, na.value = "gray") + 
     #// theme and text layouts
          theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
          labs(title = {{ title }}, caption = paste("Experiment ID:", {{ Exp_ID }})) +
     #// facet layout
          facet_grid(rows = vars( .data[[r_fac]] ), cols = vars (.data[[c_fac]]) )     

}


#// FUNCTION: Propagation of positive and negative controls


ctrl_propagation <- function(df, ctrl_level, ctrl_var, group_vars) {

group_vars <- unlist(group_vars, use.names = F)
  
#// generate a list of lists that contains all relevant controls only
temp_ctrls <- df %>%
     #// group by variables with separate DMSO controls
     group_by( across(group_vars) ) %>%
     #// identify and filter all controls
     filter( across(ctrl_var) != "none") %>%
     #// remove column for Drug_ID
     select(-.data[[ctrl_lvl]]) %>%
     #// split groups into individual lists
     nest()
#// change names of data column to dmso
names(temp_ctrls)[[which(names(temp_ctrls)=="data")]] <- "ctrl"

#// generate a list of lists that contains all data that needs appending
temp_data <- df %>%
     #// keep only items that are not Drug_controls (pos or neg)
     filter(across(ctrl_var) == "none") %>%
     #// group by variables now including Drug_ID
    group_by( across(c(group_vars, ctrl_lvl)) ) %>%
     #// split groups into individual lists
     nest()

#// merge two nested lists by Cell_Line, DOX, and time
temp_data <- full_join(temp_data, temp_ctrls)

#// keep only items that are not Drug_controls (pos or neg)
#data_m <- filter(data_m, Drug_control == "none")

#// assemble control and data and unnest
df_merged <- temp_data %>%
     #// create new list column with merged data + ctrl
     mutate(merged = map2(data, ctrl, rbind)) %>%
     #// remove extraneous data columns
     select(-data, -ctrl) %>%
     #// unnest everything into a single dataframe
     unnest(cols = c(merged))

return(df_merged)

}




```




Data analysis

```{r data import}

#// Import of meta data and organization of folders and files

#// user input of which file to load
#// should be a complete annotated data file (raw and meta data)
in_file <- "20201218_JM_data_complete"
in_dir <- "./data/"

#// output files and directory can be chosen
#// these are defaults
#// if "My_Plots" exists already it will be overwritten
out_file <- "20201218_JM_Plots"
out_dir <- "./plots/"

#// check if out_dir exists; if not make it
if (dir.exists(out_dir)==FALSE) {dir.create(out_dir)}

#// import data
suppressMessages(data <- read_tsv(paste0(in_dir,in_file,".tsv")))

#// assign unique experiment ID
#// should be included in every plot generated by the script to link output to script and data
Exp_ID <- unique(data$Experiment_ID)


```


```{r data autocleanup}

#// drop all column names with .x or .y or .z at end of word 
data[str_which(names(data), "\\.x$|\\.y$|\\.z$")] <- NULL

#// remove all columns that end in _raw (duplicates from merging)
data <- data %>% select(-ends_with("_raw")) 

#// remove spaces in column names
colnames(data) <- gsub(" ", "_", colnames(data))

#// remove all NAs in numeric and non-numeric columns
num_cols <- unname((sapply(data, is.numeric)))

data[num_cols][is.na(data[num_cols])] <- 0
data[!num_cols][is.na(data[!num_cols])] <- ""

#// clean-up
rm(num_cols)

#// empty plot list
plots <- vector(mode = "list")

```


```{r manual cleanup}
#// This section generally needs to be adjusted for specific data files
#// Examples of manual clean-up
#//    - Renamed or reorder columns
#//    - Drop unnecessary columns
#//    - pivot tables if need be
#//    - get columns into the right datatype
#//    - remove 'NULL' or NA conditions
#//    - sort by desired variables
#// 

#// manual clean up
#// specific for 20201130_AL

#// remove `untreated` wells based on a certain treatment
data <- data %>% filter(treatment_ID!="NULL" & CRISPR_ID!="NULL")

#// remove single high data point
data[data == max(data$CTG)] <- NA


#// fully assembled and cleaned up dataset
datatable(head(data), options = list(
  columnDefs = list(list(className = 'dt-center', targets = 1:ncol(data))),
  pageLength = 16,
  lengthMenu = c(8, 16, 96, 384), class = "stripe hover compact",
  style="width:100%",
  scrollX = T)
)
```

```{r quick overview, 20201218_JM}

#// overview plot

plots[[length(plots)+1]] <- data %>%

cust_box_plot(df     = ., 
              x_val  = "CRISPR_ID",
              y_val  = "CTG",
              color  = "CRISPR_ID",
              r_fac  = "Cell_Line_ID", 
              c_fac  = "treatment_ID",
              title  = "Overview of CTG vs. CRISPR", 
              Exp_ID = Exp_ID)

#// overview plots normalized

plots[[length(plots)+1]] <-

data %>% group_by(treatment_ID, Cell_Line_ID) %>%
     mutate(CTG_norm = CTG/mean(CTG[CRISPR_ID=="NC_pooled"])) %>%

cust_box_plot(df     = ., 
              x_val  = "CRISPR_ID",
              y_val  = "CTG_norm",
              color  = "CRISPR_ID",
              r_fac  = "Cell_Line_ID", 
              c_fac  = "treatment_ID",
              title  = "Overview of normalized CTG vs. CRISPR",
              Exp_ID = Exp_ID)    
 
pdf_plot(plots, name = "summary_plots", width = 16, height = 10) 


```

```{r propagate pos and neg ctrls, 20201218_JM}

#// propagate CRISPR controls
#// each CRISPR_ID will have positive (lethal) and negative (NC) control data
group_vars <- list("Cell_Line_ID", "treatment_ID", "treatment_ctrl")
ctrl_lvl   <- c("CRISPR_ID")
ctrl_var   <- c("CRISPR_ctrl")
data_ctrl  <- ctrl_propagation(data, ctrl_lvl, ctrl_var, group_vars)

#// plot of mPARP7 across cell lines and treatments
#// each facet plots positive and negative controls
plots[[length(plots)+1]] <- data_ctrl %>%
     #// filter a single CRISPR condition
     #// set this up with lapply later
     filter(CRISPR_ID == "mPARP7_pooled") %>% 
    
     cust_box_plot(df     = ., 
                   x_val  = "CRISPR_ID",
                   y_val  = "CTG",
                   color  = "CRISPR_ctrl",
                   r_fac  = "Cell_Line_ID", 
                   c_fac  = "treatment_ID",
                   title  = "mPARP7_pooled", 
                   Exp_ID = Exp_ID)

#// plot of mPARP7 across cell lines and treatments
#// normalized against NC CRISPR pooled
#// each facet plots positive and negative controls
plots[[length(plots)+1]] <- data_ctrl %>%
     
     #// filter a single CRISPR condition
     #// set this up with lapply later
     filter(CRISPR_ID == "mPARP7_pooled") %>% 
     
     #// group_by faceting variables
     group_by(treatment_ID, Cell_Line_ID) %>%

     #// control against negative control in each facet
     mutate(CTG_norm = CTG/mean(CTG[CRISPR_ctrl=="neg"])) %>%

     cust_box_plot(df     = ., 
                   x_val  = "CRISPR_ID",
                   y_val  = "CTG_norm",
                   color  = "CRISPR_ctrl",
                   r_fac  = "Cell_Line_ID", 
                   c_fac  = "treatment_ID",
                   title  = "mPARP7_pooled", 
                   Exp_ID = Exp_ID)




#// FUNCTION: Custom Box Plots for purrr

#// manual fill of all values except titles
#// easier than building the list into the datafram

purr_boxplot <- function(df, title) {

     x_val  <- "CRISPR_ctrl"
     y_val  <- "CTG"
     color  <- "CRISPR_ctrl"
     r_fac  <- "Cell_Line_ID" 
     c_fac  <- "treatment_ID"
     
     #// pipe dataframe into plot
          df %>% 
     #// basic plot setup
          ggplot(aes(x = .data[[x_val]], y = .data[[y_val]], fill = .data[[color]])) + 
     #// geoms for box_ and point_
          geom_boxplot(position = position_dodge(width = .9)) +
          geom_point(position = position_jitterdodge(dodge.width = 0.9)) +
     #// custom color scale
          scale_fill_viridis_d(begin = 0.2, end = 1, alpha = 1, direction = 1, na.value = "gray") + 
     #// theme and text layouts
          theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
          labs(title = {{ title }}, caption = paste("Experiment ID:", {{ Exp_ID }})) +
     #// facet layout
          facet_grid(rows = vars( .data[[r_fac]] ), cols = vars (.data[[c_fac]]) )     
}

purr_boxplot_norm <- function(df, title) {

     x_val  <- "CRISPR_ctrl"
     y_val  <- "CTG_norm"
     color  <- "CRISPR_ctrl"
     r_fac  <- "Cell_Line_ID" 
     c_fac  <- "treatment_ID"
     
     #// pipe dataframe into plot
          df %>% 
     #// basic plot setup
          ggplot(aes(x = .data[[x_val]], y = .data[[y_val]], fill = .data[[color]])) + 
     #// geoms for box_ and point_
          geom_boxplot(position = position_dodge(width = .9)) +
          geom_point(position = position_jitterdodge(dodge.width = 0.9)) +
     #// custom color scale
          scale_fill_viridis_d(begin = 0.2, end = 1, alpha = 1, direction = 1, na.value = "gray") + 
     #// theme and text layouts
          theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
          labs(title = {{ title }}, caption = paste("Experiment ID:", {{ Exp_ID }})) +
     #// facet layout
          facet_grid(rows = vars( .data[[r_fac]] ), cols = vars (.data[[c_fac]]) )     
}

#// generate plots for all conditions
#// use purrr solution to create column for title and column for df
#// add column for plot using custom box_plot below with most data already filled in

n_data <- data_ctrl %>% 
     #// group_by faceting variables
     group_by(treatment_ID, Cell_Line_ID) %>%
     #// control against negative control in each facet
     mutate(CTG_norm = CTG/mean(CTG[CRISPR_ctrl=="neg"])) %>%
     #// group by condition to plot against
     group_by(CRISPR_ID) %>%
     #// create nested list with all relevant information 
     nest() %>%
     #// apply function to generate plot with map
     mutate( plots = map2(data, CRISPR_ID, purr_boxplot) ) %>%
     #// apply function to generate plot with map
     mutate( norm_plots = map2(data, CRISPR_ID, purr_boxplot_norm) )

#// readout plots from dataframe
pdf_plot(append(n_data$plots, n_data$norm_plots), name = "normalized_plots", width = 16, height = 10) 
stop()


```





```{r IFN-g overview, fig.width=16, fig.height=10}

#// analysis developed for 20201130_AL

data %>% filter(time = 138 ) %>%
  
     ggplot(data = data, mapping = aes(x = Drug_ID, y = `IFN-g`, color = Drug_conc)) +
     geom_boxplot() +
     geom_point(aes(color = Drug_conc)) +
     stat_summary(fun = mean, geom = "point") +
    
     #// adjust guides and scales
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "gray", trans = "log",
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
#//     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
     theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
     
     #// titles and captions
     labs(title = paste("CT26sh0 treated with dose response of Barasertib", "\nDox = neg") ,
          caption = paste("Experiment ID:", Exp_ID)) +
    
       
     #// display remainder of variables in face_wrap or facet_grid
     facet_wrap(DOX_ID ~ Cell_Line_ID)   

     

```


```{r timecourse overview, fig.width=16, fig.height=10}

#// analysis developed for 20201130_AL

#// single drug and single dose
plots[[length(plots)+1]] <- data %>%
     
#// data manipulations
     #// filter out everything but a single cell line to start
     filter(Cell_Line_ID == "CT26sh0") %>%
     #// filter out everything but a single drug to start
     filter(Drug_ID == "Barasertib") %>%
     #// filter out everyting but a single concentration
     filter(Drug_conc == 0.01) %>%
     #// filter only on no_DOX treatment
     filter(DOX_ID == "neg") %>%

#// plot generation
     #// basic plot elements
     ggplot(aes(x = time, y = confluence)) +
     geom_point() +
     geom_smooth() +
     
     #// titles and captions
     labs(title = paste("CT26sh0 treated with 0.01uM Barasertib", "\nDox = neg") ,
          caption = paste("Experiment ID:", Exp_ID))



#// include drug dose response
plots[[length(plots)+1]] <- data %>%
     
#// data manipulations
     #// filter out everything but a single cell line to start
     filter(Cell_Line_ID == "CT26sh0") %>%
     #// filter out everything but a single drug to start
     filter(Drug_ID == "Barasertib") %>%
     #// exclude t=0 because of artifacts
     filter(time != 0) %>%
     #// filter only on no_DOX treatment
     filter(DOX_ID == "neg") %>%

#// plot generation
     #// basic plot elements
     ggplot(aes(x = time, y = confluence, color = Drug_conc)) +
     geom_point() +
     geom_smooth(aes(group = Drug_conc)) +
     
     #// adjust guides and scales
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "gray", trans = "log",
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
     
     #// titles and captions
     labs(title = paste("CT26sh0 treated with dose response of Barasertib", "\nDox = neg") ,
          caption = paste("Experiment ID:", Exp_ID))


#// facet wrap of sh0
plots[[length(plots)+1]] <- data %>%
     
#// data manipulations
     #// filter out everything but a single cell line to start
     filter(Cell_Line_ID == "CT26sh0") %>%
     #// exclude t=0 because of artifacts
     filter(time != 0) %>%
     #// filter only on no_DOX treatment
     filter(DOX_ID == "neg") %>%
     #// exclude DMSO from plot
     filter(Drug_ID != "DMSO") %>%

#// plot generation
     #// basic plot elements
     ggplot(aes(x = time, y = confluence, color = Drug_conc)) +
     geom_point() +
     geom_smooth(aes(group = Drug_conc)) +
     
     #// adjust guides and scales
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "gray", trans = "log",
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
     
     #// titles and captions
     labs(title = paste("CT26sh0 treated with dose response of all drugs", "\nDox = neg"),
          caption = paste("Experiment ID:", Exp_ID)) +
     
     #// display remainder of variables in face_wrap or facet_grid
     facet_wrap("Drug_ID")



#// facet wrap of sh2

plots[[length(plots)+1]] <- data %>% 
     
#// data manipulations
     #// filter out everything but a single cell line to start
     filter(Cell_Line_ID == "CT26sh2") %>%
     #// exclude t=0 because of artifacts
     filter(time != 0) %>%
     #// filter only on no_DOX treatment
     filter(DOX_ID == "neg") %>%
     #// exclude DMSO from plot
     filter(Drug_ID != "DMSO") %>%

#// plot generation     
     #// basic plot elements
     ggplot(aes(x = time, y = confluence, color = Drug_conc)) +
     geom_point() +
     geom_smooth(aes(group = Drug_conc)) +
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "gray", trans = "log",
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
          
     #// titles and captions
     labs(title = paste("CT26sh2 treated with dose response of all drugs", "\nDox = neg"),
          caption = paste("Experiment ID:", Exp_ID)) +
     
     #// display remainder of variables in face_wrap or facet_grid
     facet_wrap("Drug_ID")

#// facet wrap of sh0

plots[[length(plots)+1]] <- data %>%
     
#// data manipulations
     #// filter out everything but a single cell line to start
     filter(Cell_Line_ID == "CT26sh0") %>%
     #// exclude t=0 because of artifacts
     filter(time != 0) %>%
     #// filter only on no_DOX treatment
     filter(DOX_ID == "pos") %>%
     #// exclude DMSO from plot
     filter(Drug_ID != "DMSO") %>%

#// plot generation
     #// basic plot elements
     ggplot(aes(x = time, y = confluence, color = Drug_conc)) +
     geom_point() +
     geom_smooth(aes(group = Drug_conc)) +
     
     #// adjust guides and scales
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "gray", trans = "log",
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
     
     #// titles and captions
     labs(title = paste("CT26sh0 treated with dose response of all drugs", "\nDox = pos"),
          caption = paste("Experiment ID:", Exp_ID)) +
     
     #// display remainder of variables in face_wrap or facet_grid
     facet_wrap("Drug_ID")



#// facet wrap of sh2

plots[[length(plots)+1]] <- data %>%
     
#// data manipulations
     #// filter out everything but a single cell line to start
     filter(Cell_Line_ID == "CT26sh2") %>%
     #// exclude t=0 because of artifacts
     filter(time != 0) %>%
     #// filter only on no_DOX treatment
     filter(DOX_ID == "pos") %>%
     #// exclude DMSO from plot
     filter(Drug_ID != "DMSO") %>%

#// plot generation     
     #// basic plot elements
     ggplot(aes(x = time, y = confluence, color = Drug_conc)) +
     geom_point() +
     geom_smooth(aes(group = Drug_conc)) +
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "gray", trans = "log", 
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
          
     #// titles and captions
     labs(title = paste("CT26sh2 treated with dose response of all drugs", "\nDox = pos"),
          caption = paste("Experiment ID:", Exp_ID)) +
     
     #// display remainder of variables in face_wrap or facet_grid
     facet_wrap("Drug_ID")





#// focus on Ruxolitinib for both cell lines and +/- DOX
plots[[length(plots)+1]] <- data %>%
     
#// data manipulations
     #// exclude t=0 because of artifacts
     filter(time != 0) %>%
     #// filter only on Ruxolitinib
     filter(Drug_ID == "Ruxlotinib") %>% #// NOTE THAT Ruxolitinib is misspelled in D300 file!

#// plot generation     
     #// basic plot elements
     ggplot(aes(x = time, y = confluence, color = Drug_conc)) +
     geom_point() +
     geom_smooth(aes(group = Drug_conc)) +
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "gray", trans = "log", 
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
          
     #// titles and captions
     labs(title = paste("focus on Ruxolitinib for both cell lines and +/- DOX"),
          caption = paste("Experiment ID:", Exp_ID)) +
     
     #// display remainder of variables in face_wrap or facet_grid
     facet_wrap(DOX_ID ~ Cell_Line_ID)



#// DMSO control for both cell lines and +/- DOX
plots[[length(plots)+1]] <- data %>%
     
#// data manipulations
     #// exclude t=0 because of artifacts
     filter(time != 0) %>%
     #// filter only on DMSO
     filter(Drug_ID == "DMSO") %>% 

#// plot generation     
     #// basic plot elements
     ggplot(aes(x = time, y = confluence, color = Drug_conc)) +
     geom_point() +
     geom_smooth(aes(group = Drug_conc)) +
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "gray", trans = "log", 
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
          
     #// titles and captions
     labs(title = paste("DMSO control for both cell lines and +/- DOX"),
          caption = paste("Experiment ID:", Exp_ID)) +
     
     #// display remainder of variables in face_wrap or facet_grid
     facet_wrap(DOX_ID ~ Cell_Line_ID)
```


```{r timecourse overview - including neg controls, fig.width=16, fig.height=10}

#// analysis developed for 20201130_AL


#// call DMSO controls across Drug_IDs
df <- data
group_vars <- list("Cell_Line_ID", "DOX_ID", "time")
ctrl_lvl <- c("Drug_ID")
ctrl_var <- c("Drug_control")

x <- ctrl_propagation(data, ctrl_lvl, ctrl_var, group_vars)



#// now put this together with full data
#// now should have more control over look of control data
#// works -- now have full control
#// don't need to have separate readout for controls

#// too lazy to write lapply/mapply function


#// DMSO control for both cell lines and +/- DOX

#// no dox, sh0
plots[[length(plots)+1]] <- data_m %>%
     
#// data manipulations
     #// exclude t=0 because of artifacts
     filter(time != 0) %>%
     filter(DOX_ID == "neg" & Cell_Line_ID == "CT26sh0") %>%

#// plot generation     
     #// basic plot elements
     #// '.' means that data value is passed through from before
     ggplot(data = .) +
     #// plot the drug results
     geom_smooth(data = . %>% filter(Drug_control == "none"), aes(x = time, y = confluence, group = Drug_conc, color = Drug_conc)) +
     geom_point(data = . %>% filter(Drug_control == "none"), aes(x = time, y = confluence, group = Drug_conc, color = Drug_conc)) +
     #// plot the controls
     #// setting attributes like linetype in aes means they will be filled with the appropriate value of the variable
     #// they can be specified in the legend to represent the appropriate values for plotting (e.g. "red", "dashed", ...)
     #// group within aes means that based on the value of this variable things will be plotted differently
     #// this setup allows for multiple pos and neg controls as long as they are specified in Drug_control column
     geom_smooth(data = . %>% filter(Drug_control == "neg"), aes(x = time, y = confluence, group = Drug_control, linetype = Drug_control), color = "red", size = 1.5) +  
     
     
     #// adjust scales and display types
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "red", trans = "log", 
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
     #// manual conversion of legend variables to attributes and labels
     scale_linetype_manual(name = "Controls", values =c("neg" = "dashed"), labels = c("DMSO control")) +
     #// change the display order of the two legends
     guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2)) +

     
     #// titles and captions
     labs(title = paste("All conditions with all appropriate DMSO controls propagated to each plot.\nCell Line: CT26sh0 / DOX: neg"),
          caption = paste("Experiment ID:", Exp_ID)) +
     
     #// display remainder of variables in face_wrap or facet_grid
     facet_wrap(vars(Drug_ID), ncol = 3)



#// dox, sh0
plots[[length(plots)+1]] <- data_m %>%
     
#// data manipulations
     #// exclude t=0 because of artifacts
     filter(time != 0) %>%
     filter(DOX_ID == "pos" & Cell_Line_ID == "CT26sh0") %>%

#// plot generation     
     #// basic plot elements
     #// '.' means that data value is passed through from before
     ggplot(data = .) +
     #// plot the drug results
     geom_smooth(data = . %>% filter(Drug_control == "none"), aes(x = time, y = confluence, group = Drug_conc, color = Drug_conc)) +
     geom_point(data = . %>% filter(Drug_control == "none"), aes(x = time, y = confluence, group = Drug_conc, color = Drug_conc)) +
     #// plot the controls
     #// setting attributes like linetype in aes means they will be filled with the appropriate value of the variable
     #// they can be specified in the legend to represent the appropriate values for plotting (e.g. "red", "dashed", ...)
     #// group within aes means that based on the value of this variable things will be plotted differently
     #// this setup allows for multiple pos and neg controls as long as they are specified in Drug_control column
     geom_smooth(data = . %>% filter(Drug_control == "neg"), aes(x = time, y = confluence, group = Drug_control, linetype = Drug_control), color = "red", size = 1.5) +  
     
     
     #// adjust scales and display types
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "red", trans = "log", 
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
     #// manual conversion of legend variables to attributes and labels
     scale_linetype_manual(name = "Controls", values =c("neg" = "dashed"), labels = c("DMSO control")) +
     #// change the display order of the two legends
     guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2)) +

     
     #// titles and captions
     labs(title = paste("All conditions with all appropriate DMSO controls propagated to each plot.\nCell Line: CT26sh0 / DOX: pos"),
          caption = paste("Experiment ID:", Exp_ID)) +
     
     #// display remainder of variables in face_wrap or facet_grid
     facet_wrap(vars(Drug_ID), ncol = 3)


#// no dox, sh2
plots[[length(plots)+1]] <- data_m %>%
     
#// data manipulations
     #// exclude t=0 because of artifacts
     filter(time != 0) %>%
     filter(DOX_ID == "neg" & Cell_Line_ID == "CT26sh2") %>%

#// plot generation     
     #// basic plot elements
     #// '.' means that data value is passed through from before
     ggplot(data = .) +
     #// plot the drug results
     geom_smooth(data = . %>% filter(Drug_control == "none"), aes(x = time, y = confluence, group = Drug_conc, color = Drug_conc)) +
     geom_point(data = . %>% filter(Drug_control == "none"), aes(x = time, y = confluence, group = Drug_conc, color = Drug_conc)) +
     #// plot the controls
     #// setting attributes like linetype in aes means they will be filled with the appropriate value of the variable
     #// they can be specified in the legend to represent the appropriate values for plotting (e.g. "red", "dashed", ...)
     #// group within aes means that based on the value of this variable things will be plotted differently
     #// this setup allows for multiple pos and neg controls as long as they are specified in Drug_control column
     geom_smooth(data = . %>% filter(Drug_control == "neg"), aes(x = time, y = confluence, group = Drug_control, linetype = Drug_control), color = "red", size = 1.5) +  
     
     
     #// adjust scales and display types
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "red", trans = "log", 
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
     #// manual conversion of legend variables to attributes and labels
     scale_linetype_manual(name = "Controls", values =c("neg" = "dashed"), labels = c("DMSO control")) +
     #// change the display order of the two legends
     guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2)) +

     
     #// titles and captions
     labs(title = paste("All conditions with all appropriate DMSO controls propagated to each plot.\nCell Line: CT26sh2 / DOX: neg"),
          caption = paste("Experiment ID:", Exp_ID)) +
     
     #// display remainder of variables in face_wrap or facet_grid
     facet_wrap(vars(Drug_ID), ncol = 3)


#// dox, sh2
plots[[length(plots)+1]] <- data_m %>%
     
#// data manipulations
     #// exclude t=0 because of artifacts
     filter(time != 0) %>%
     filter(DOX_ID == "pos" & Cell_Line_ID == "CT26sh2") %>%

#// plot generation     
     #// basic plot elements
     #// '.' means that data value is passed through from before
     ggplot(data = .) +
     #// plot the drug results
     geom_smooth(data = . %>% filter(Drug_control == "none"), aes(x = time, y = confluence, group = Drug_conc, color = Drug_conc)) +
     geom_point(data = . %>% filter(Drug_control == "none"), aes(x = time, y = confluence, group = Drug_conc, color = Drug_conc)) +
     #// plot the controls
     #// setting attributes like linetype in aes means they will be filled with the appropriate value of the variable
     #// they can be specified in the legend to represent the appropriate values for plotting (e.g. "red", "dashed", ...)
     #// group within aes means that based on the value of this variable things will be plotted differently
     #// this setup allows for multiple pos and neg controls as long as they are specified in Drug_control column
     geom_smooth(data = . %>% filter(Drug_control == "neg"), aes(x = time, y = confluence, group = Drug_control, linetype = Drug_control), color = "red", size = 1.5) +  
     
     
     #// adjust scales and display types
     scale_color_viridis_c(begin = 0, alpha = 0.5, direction = -1, na.value = "red", trans = "log", 
                           breaks = c(10, 3.1, 1, 0.31, 0.1, 0.03, 0.01, 0.003, 0.001)) + 
     scale_x_continuous(breaks = seq(from = 6, to = 138, by = 12)) +
     #// manual conversion of legend variables to attributes and labels
     scale_linetype_manual(name = "Controls", values =c("neg" = "dashed"), labels = c("DMSO control")) +
     #// change the display order of the two legends
     guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2)) +

     
     #// titles and captions
     labs(title = paste("All conditions with all appropriate DMSO controls propagated to each plot.\nCell Line: CT26sh2 / DOX: pos"),
          caption = paste("Experiment ID:", Exp_ID)) +
     
     #// display remainder of variables in face_wrap or facet_grid
     facet_wrap(vars(Drug_ID), ncol = 3)


```




##// Stuff below here is from previous analyses
Keep collecting these things and use the fragments later as a 'menu' for starting points of analysis

```{r basic plots}

#// analysis developed for 20201203_BG_INFg treatments

#// trying out different scales and different x/y combinations to explore data

d1 <- data

ggplot(data=d1, aes(Time_days, Cell_No, color = cytokine_conc, group = cytokine_conc, shape = Cell_Line, group = Cell_Line)) +
          geom_point() +
          stat_summary(fun = mean, geom = "point") +
          stat_summary(fun = mean, geom = "line") + 
          facet_wrap( ~ Cell_Line, ncol=3)
          
ggplot(data=d1, aes(x=Time_days, y=Cyto_W3 , color = Cell_Line, group = Cell_Line)) +
          xlim(0.1, 500) +
#//          ylim(0, 1000) +      
#//          scale_x_continuous(trans=scales::pseudo_log_trans(base = 2)) +
          scale_x_continuous(trans='log2') +
          geom_point() +
          stat_summary(fun = mean, geom = "point") +
          stat_summary(fun = mean, geom = "line") + 
          facet_grid(antibody_ID ~ cytokine_conc)

          
ggplot(data=d1, aes(x=Time_days, y=Cyto_W3 , color = cytokine_conc, group = cytokine_conc)) +
 #//        xlim(0.1, 500) +
#//          ylim(0, 1000) +      
#//          scale_x_continuous(trans=scales::pseudo_log_trans(base = 2)) +
 #//         scale_x_continuous(trans='log2') +
          geom_point() +
          stat_summary(fun = mean, geom = "point") +
          stat_summary(fun = mean, geom = "line") + 
          facet_grid(antibody_ID ~ Cell_Line)

ggplot(data=d1, aes(x=as.factor(cytokine_conc), y=Cell_W3 , color = drug_ID)) +
 #//         xlim(0.1, 500) +
#//          ylim(0, 1000) +      
#//          scale_x_continuous(trans=scales::pseudo_log_trans(base = 2)) +
 #//         scale_x_continuous(trans='log2') +
          geom_boxplot() +
          facet_grid(Cell_Line ~ Time_days)





```


```{r lapply antibodies, 20201203_BG_INFg}

#// analysis developed for 20201203_BG_INFg treatments

#// testing ground/template for antibody_plot function

     #// data %>%
     #// filter(antibody_ID=="PARP14") %>%
     #// ggplot(aes(x=as.factor(cytokine_conc), y=Cell_W3 , color = drug_ID)) +
     #// geom_boxplot() +
     #// facet_grid(Cell_Line ~ Time_days) + 
     #// labs(title=paste("Antibody:", "PARP14"))

#// function that cycles through all antibodies in 'antibody' column
#// uses filter to only select a single Ab
#// plots the readout for a single readout (Cell_W3)
 
     antibody_plot <- function(filter, data) {

     data %>%
     filter(antibody_ID==filter) %>%
     ggplot(aes(x=as.factor(cytokine_conc), y=Cell_W3 , color = drug_ID)) +
          geom_boxplot() +
     facet_grid(Cell_Line ~ Time_days) +
     labs(title = paste("Antibody:", filter) ,
     caption = paste("Experiment ID:", Exp_ID))
     }             

ab <- unique(data$antibody_ID)
lapply(ab, antibody_plot, data)


```


```{r lapply readouts, 20201203_BG_INFg }

#// analysis developed for 20201203_BG_INFg treatments


#// This lapply replaces the individual calls across all readouts for a single antibody
 
readout_plot <- function(readout, data) {  #// print(paste("Readout:", readout, " and Antibody:", antibody)) }
 
     data %>%
     filter(antibody_ID=="MAR") %>%
     ggplot(aes_string(x="as.factor(cytokine_conc)", y=readout , color ="drug_ID")) +
     geom_boxplot() +
     facet_grid(Cell_Line ~ Time_days) +
     labs(title = paste("Readout:", readout, "\n Antibody: MAR"),
          caption = paste("Experiment ID:", Exp_ID))
     }

readouts <- c("Cell_W2", "Cell_W3", "Nuc_W2", "Nuc_W3", "Cyto_W2", "Cyto_W3", "Fraction_W2", "Fraction_W3", "Cell_No" )
myplots <- lapply(readouts, readout_plot, data)




```


```{r PDF of patch plot, fig.width=16, fig.height=12, 20201203_BG_INFg}

#// analysis developed for 20201203_BG_INFg treatments

#// fig.width=16, fig.height=12 in Mardown code stipulates the size of the images printed
#// now combine the two approaches above and iterate through antibodies and readouts programmatically
#// use mapply to cycle through two vectors


#// function for two factor plot
two_factor_plot <- function(readout, antibody, data) {  #// print(paste("Readout:", readout, " and Antibody:", antibody)) }
 
     data %>%
     filter(antibody_ID==antibody) %>%
     ggplot(aes_string(x="as.factor(cytokine_conc)", y=readout , color ="drug_ID")) +
     geom_boxplot() +
     facet_grid(Cell_Line ~ Time_days) +
     labs(title = paste("Readout:", readout, "\nAntibody:", antibody) ,
          caption = paste("Experiment ID:", Exp_ID))
     }


#// generate pairwise combination of readouts and antibodies
readouts <- c("Cell_W2", "Cell_W3", "Nuc_W2", "Nuc_W3", "Cyto_W2", "Cyto_W3", "Fraction_W2", "Fraction_W3", "Cell_No" )
antibodies <- unique(data$antibody_ID)
combo <- expand.grid(readouts=readouts, antibodies=antibodies)

#// call mapply with the combination

myplots <- mapply(two_factor_plot, as.character(combo[[1]]), as.character(combo[[2]]), MoreArgs = list(data), SIMPLIFY = FALSE)  



#// using patchwork for layout

#// single page with six plots
#// arrange these functions based on the number and grouping per plot
#// can arrange order here or with the 'combo' vector used to call the plotting function
six_patch_plot <- function(i, plots) {
         ( plots[[i]] + plots[[i+2]] + plots[[i+4]] ) / ( plots[[i+1]] + plots[[i+3]]  + plots[[i+5]] ) + plot_layout(guides = 'collect') }

three_patch_plot <- function(i, plots) {
         ( plots[[i+6]] + plots[[i+8]] + plot_spacer() ) / ( plots[[i+7]] + plot_spacer() + plot_spacer() ) + plot_layout(guides = 'collect') }

#// plotting the groups of of 6 and 3 onto individual patchwork plots
composite1 <- lapply(c(1,10,19,28), six_patch_plot, myplots)
composite2 <- lapply(c(1,10,19,28), three_patch_plot, myplots)


#// Stitching together the pdf file
#// width and height needs match 'fig.width=16, fig.height=12' in Markdown code 

pdf(file = paste0(out_dir, out_file, ".pdf"),   #// The directory you want to save the file in
    width = 16, #// The width of the plot in inches
    height = 12) #// The height of the plot in inches

for (i in 1:4) {
     print(composite1[[i]])
     print(composite2[[i]])
}
dev.off()
invisible(NULL)

```


```{r basic plots}

#// analysis developed for 20200908_AL (stressor screen)

#// trying out different scales and different x/y combinations to explore data

d1 <- data

d1 %>% filter(Cell_Line == "A375") %>%

    ggplot(aes(x = drug_conc, y= Cell_No, color = drug_ID)) +
    geom_line() +
    stat_summary(fun = mean, geom = "point") +
    stat_summary(fun = mean, geom = "line") + 
    facet_wrap( ~ drug_ID, ncol=3) +
    theme(axis.text.x = element_text(angle = 90))
 

#// not normalized

d1 %>% group_by(Cell_Line) %>%  mutate(Cell_No_norm = Cell_No/mean(Cell_No[drug_ID=="DMSO"])) %>%
    
    filter(drug_ID != "DMSO" & drug_ID != "Staurosporin") %>%

    ggplot(aes(x = drug_ID, y = Cell_No)) +
    geom_boxplot() +
    geom_point(aes(color=drug_conc)) +
    
    scale_color_viridis_d(begin = 1, end = 0, alpha = 1, direction = 1, na.value = "gray") +
    
    stat_summary(fun = mean, geom = "point") +
    facet_wrap( ~ Cell_Line, ncol=3) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))


d1 %>% group_by(Cell_Line) %>%  mutate(Fraction_W2_norm = Fraction_W2/mean(Fraction_W2[drug_ID=="DMSO"])) %>%

    ggplot(aes(x = drug_ID, y= Fraction_W2)) +
    geom_boxplot() +
    geom_point(aes(color=drug_conc)) +
    
    scale_color_viridis_d(begin = 1, end = 0, alpha = 1, direction = 1, na.value = "gray") +
    
    stat_summary(fun = mean, geom = "point") +
    facet_wrap( ~ Cell_Line, ncol=3) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))


d1 %>% group_by(Cell_Line) %>%  mutate(Fraction_W3_norm = Fraction_W3/mean(Fraction_W3[drug_ID=="DMSO"])) %>%

    ggplot(aes(x = drug_ID, y = Fraction_W3)) +
    geom_boxplot() +
    geom_point(aes(color=drug_conc)) +
    
    scale_color_viridis_d(begin = 1, end = 0, alpha = 1, direction = 1, na.value = "gray") +
    
    stat_summary(fun = mean, geom = "point") +
    facet_wrap( ~ Cell_Line, ncol=3) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))


#// normalized


d1 %>% group_by(Cell_Line) %>%  mutate(Cell_No_norm = Cell_No/mean(Cell_No[drug_ID=="DMSO"])) %>%
    
    filter(drug_ID != "DMSO" & drug_ID != "Staurosporin") %>%

    ggplot(aes(x = drug_ID, y = Cell_No_norm)) +
    geom_boxplot() +
    geom_point(aes(color=drug_conc)) +
    
    scale_color_viridis_d(begin = 1, end = 0, alpha = 1, direction = 1, na.value = "gray") +
    
    stat_summary(fun = mean, geom = "point") +
    facet_wrap( ~ Cell_Line, ncol=3) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))


d1 %>% group_by(Cell_Line) %>%  mutate(Fraction_W2_norm = Fraction_W2/mean(Fraction_W2[drug_ID=="DMSO"])) %>%

    ggplot(aes(x = drug_ID, y= Fraction_W2_norm)) +
    geom_boxplot() +
    geom_point(aes(color=drug_conc)) +
    
    scale_color_viridis_d(begin = 1, end = 0, alpha = 1, direction = 1, na.value = "gray") +
    
    stat_summary(fun = mean, geom = "point") +
    facet_wrap( ~ Cell_Line, ncol=3) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))


d1 %>% group_by(Cell_Line) %>%  mutate(Fraction_W3_norm = Fraction_W3/mean(Fraction_W3[drug_ID=="DMSO"])) %>%

    ggplot(aes(x = drug_ID, y = Fraction_W3_norm)) +
    geom_boxplot() +
    geom_point(aes(color=drug_conc)) +
    
    scale_color_viridis_d(begin = 1, end = 0, alpha = 1, direction = 1, na.value = "gray") +
    
    stat_summary(fun = mean, geom = "point") +
    facet_wrap( ~ Cell_Line, ncol=3) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))




```


```{r lapply, fig.width=16, fig.height=12}

#// analysis developed for 20200908_AL (stressor screen)

#// log_scale W2 norm

log_plot <- d1 %>%
  
    group_by(Cell_Line) %>%  mutate(Fraction_W2_norm = Fraction_W2/mean(Fraction_W2[drug_ID=="DMSO"])) %>%

    ggplot(aes(x = drug_ID, y = Fraction_W2_norm)) +
    scale_y_log10(limits = c(0.5, 80), breaks = c(1, 3.16, 10, 31.6)) +
    
    geom_boxplot() +
    geom_point(aes(color=drug_conc)) +
    
    scale_color_viridis_d(begin = 1, end = 0, alpha = 1, direction = 1, na.value = "gray") +
    
    stat_summary(fun = mean, geom = "point") +
    facet_wrap( ~ Cell_Line, ncol=3) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(title = paste("Readout:", " Fraction_W2_norm"),
    caption = paste("Experiment ID:", Exp_ID))




#// normalize all by DMSO

data_norm <- data %>%   group_by(Cell_Line) %>%
                        mutate(Cell_No_norm = Cell_No/mean(Cell_No[drug_ID=="DMSO"])) %>%
                        mutate(Fraction_W2_norm = Fraction_W2/mean(Fraction_W2[drug_ID=="DMSO"])) %>%
                        mutate(Fraction_W3_norm = Fraction_W3/mean(Fraction_W3[drug_ID=="DMSO"]))

   

#// This lapply replaces the individual calls across all readouts for a single antibody
 
readout_plot <- function(readout, data) { 


    data %>% group_by(Cell_Line) %>%  mutate(Cell_No_norm = Cell_No/mean(Cell_No[drug_ID=="DMSO"])) %>%
    
    filter(drug_ID != "DMSO" & drug_ID != "Staurosporin") %>%

    ggplot(aes_string(x = "drug_ID", y = readout)) +
    geom_boxplot() +
    geom_point(aes(color=drug_conc)) +
    
    scale_color_viridis_d(begin = 1, end = 0, alpha = 1, direction = 1, na.value = "gray") + 
    
    stat_summary(fun = mean, geom = "point") +
    facet_wrap( ~ Cell_Line, ncol=3) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(title = paste("Readout:", readout),
    caption = paste("Experiment ID:", Exp_ID))
    
}    



readouts <- c("Cell_No", "Fraction_W2", "Fraction_W3", "Cell_No_norm", "Fraction_W2_norm", "Fraction_W3_norm")
plots <- lapply(readouts, readout_plot, data_norm)
 
print ( ( plots[[1]] + plots[[2]] + plots[[3]] ) / ( plots[[4]] + plots[[5]]  + plots[[6]] ) + plot_layout(guides = 'collect') )

print( log_plot)




```


```{r PDF of patch plot, fig.width=16, fig.height=12}


#// analysis developed for 20200908_AL (stressor screen)

#// using patchwork for layout and print a pdf



pdf(file = paste0(out_dir, out_file, ".pdf"),   #// The directory you want to save the file in
    width = 16, #// The width of the plot in inches
    height = 12) #// The height of the plot in inches

#// single page with six plots
print( ( plots[[1]] + plots[[2]] + plots[[3]] ) / ( plots[[4]] + plots[[5]]  + plots[[6]] ) + plot_layout(guides = 'collect') )

#// y log scale
print( log_plot)

#// one plot per page
for (i in 1:6) { ( print(plots[[i]]) ) } 

dev.off()
invisible(NULL)




```



### Version History

## version 0.3

# extended for 20201218_JM
- functionalized custom box plots and pdf creation
- functionalized propagation of positive and negative controls
- purrr solution for easy grouped plots (use 20201005_KK as template)

## version 0.2

# made for 20201130_A
- timeseries analysis from IncuCyte with multiple plates, drugs, cell lines, DOX treatments
- implemented proper plotting of controls in facet plot with control over layout and legends
- implemented purrr solution to propagate controls from plate level to measurement level by group


